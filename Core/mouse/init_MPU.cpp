#include "init_mpu.hpp"
#include "iodefine.h"
#include "debug.hpp"
void init_sys(){
			
	SYSTEM.PRCR.WORD = 0xa50b;		//?N???b?N?\?[?XÅeIÅed?I?U?i?IÅÒd??

	SYSTEM.PLLWTCR.BYTE = 0x0F;		/* 4194304cycle(Default) */
	SYSTEM.PLLCR.WORD = 0x0F00;		/* PLL ÅfuÅh{?~16 Ågu?I1?a?u (12.000MHz * 16 = 192MHz)*/
	SYSTEM.PLLCR2.BYTE = 0x00;		/* PLL ENABLE */
		
	// ICK   : 192/2 = 96MHz 		// ?V?X?e???N???b?N CPU DMAC DTC ROM RAM
	// PCLKA : 192/2 = 96MHz 		// ?u?O???W?Åc?[???N???b?NA ETHERC?AEDMAC?ADEU
	// PCLKB : 192/4 = 48MHz 		// ?u?O???W?Åc?[???N???b?NB ?a?L?E?O PCLKB=PCLK
/*	
	SYSTEM.SCKCR.BIT.FCK=0x02;		//FCLK MAX 50MHz  192/4
	SYSTEM.SCKCR.BIT.ICK=0x01;		//ICLK MAX 100MHz 192/2
	SYSTEM.SCKCR.BIT.PSTOP1=0x01;	//BCLK ?o?IÅfa?~
	SYSTEM.SCKCR.BIT.PSTOP0=0x01;	//SDCLK ?o?IÅfa?~
	SYSTEM.SCKCR.BIT.BCK=0x02;		//BCLK MAX 100MHz ICLK?EÅÒo?E?ÅE?e?K?v?a???e192/4
	SYSTEM.SCKCR.BIT.PCKA=0x01;		//PCLKA MAX 100MHz 192/2
	SYSTEM.SCKCR.BIT.PCKB=0x02;		//PCLKB MAX 50MHz 192/4
	//?a?L?I?YÅfe?A?I?3?É ?-clock?YÅfe?a?A?Å·?E?Åë???sÅÒo?L?I?a???E?e?Åˆ?A?YÅfe?ÅE?e?Å}?A
*/
	SYSTEM.SCKCR.LONG = 0x21C21211;	//FCK1/4 ICK1/2 BCLKÅfa?~ SDCLKÅfa?~ BCK1/4 PCLKA1/2 PCLKB1/4
/*
	SYSTEM.SCKCR2.BIT.UCK=0x03;		//UCLK MAX 48MHz 192/4
	SYSTEM.SCKCR2.BIT.IEBCK=0x02;	//IECLK MAX 50MHz 192/4
*/
	SYSTEM.SCKCR2.WORD = 0x0032;	/* UCLK1/4 IEBCK1/4 */
	SYSTEM.BCKCR.BYTE = 0x01;		/* BCLK = 1/2 */
	
	SYSTEM.SCKCR3.WORD = 0x0400;	//PLLÅÒn?HÅeIÅed

}

void init_delay_clk(){
	SYSTEM.PRCR.WORD = 0xA502;
	MSTP(CMT3) = 0;
	SYSTEM.PRCR.WORD = 0xA500;	
	
	//CMT0?I?Åò?a???e???Y?p?^?C?}?A?É ?A?g?p
	CMT3.CMCR.BIT.CKS=1;	// PCLK/32 1.5MHz
	CMT3.CMCR.BIT.CMIE=1;	//???e???Y?d??ÅÒA
	CMT3.CMCNT=0;			//?J?E?Åg?^?[?I?N???A
	CMT3.CMCOR=1500-1;		//1kHz

	IEN(CMT3,CMI3) = 1;		//???e???Y?v???d??ÅÒA 
	IPR(CMT3,CMI3) = 9;	//???e???Y?D?aÅgx 15?a?A??
	IR(CMT3,CMI3)=0;		//???e???Y?X?e?[?^?t?ÅÒ?O?d?N???A
	
	CMT.CMSTR1.BIT.STR3=1;	//?J?E?Åg?g?X?^?[?g
	
}

void init_clk(){
	SYSTEM.PRCR.WORD = 0xA502;
	MSTP(CMT0) = 0;
	MSTP(CMT1) = 0;
	MSTP(CMT2) = 0;
    SYSTEM.PRCR.WORD = 0xA500;	
	
	//CMT0?I?Åò?a???e???Y?p?^?C?}?A?É ?A?g?p
	CMT0.CMCR.BIT.CKS=1;	// PCLK/32 1.5MHz
	CMT0.CMCR.BIT.CMIE=1;	//???e???Y?d??ÅÒA
	CMT0.CMCNT=0;			//?J?E?Åg?^?[?I?N???A
	CMT0.CMCOR=1500-1;		//1kHz

	IEN(CMT0,CMI0) = 1;		//???e???Y?v???d??ÅÒA 
	IPR(CMT0,CMI0) = 15;	//???e???Y?D?aÅgx 15?a?A??
	IR(CMT0,CMI0)=0;		//???e???Y?X?e?[?^?t?ÅÒ?O?d?N???A
	
	//CMT1?I?Z?Åg?T?[?Åò?a?p?^?C?}?A?É ?A?g?p
	CMT1.CMCR.BIT.CKS=1;	// PCLK/32 1.5MHz
	CMT1.CMCR.BIT.CMIE=1;	//???e???Y?d??ÅÒA
	CMT1.CMCNT=0;			//?J?E?Åg?^?[?I?N???A
	CMT1.CMCOR=(1500/4)-1;	//4kHz

	IEN(CMT1,CMI1) = 1;		//???e???Y?v???d??ÅÒA 
	IPR(CMT1,CMI1) = 14;	//???e???Y?D?aÅgx?d??Åg_?E?YÅfe
	IR(CMT1,CMI1)=0;		//???e???Y?X?e?[?^?t?ÅÒ?O?d?N???A

	//CMT2?I1ms?I?^?C?}?[?J?E?Åg?^?p?^?C?}?A?É ?A?g?p
	CMT2.CMCR.BIT.CKS=1;	// PCLK/32 1.5MHz
	CMT2.CMCR.BIT.CMIE=1;	//???e???Y?d??ÅÒA
	CMT2.CMCNT=0;			//?J?E?Åg?^?[?I?N???A
	CMT2.CMCOR=15000-1;		//100Hz

	IEN(CMT2,CMI2) = 1;		//???e???Y?v???d??ÅÒA 
	IPR(CMT2,CMI2) = 10;	//???e???Y?D?aÅgx 15?a?A??
	IR(CMT2,CMI2)=0;		//???e???Y?X?e?[?^?t?ÅÒ?O?d?N???A

	CMT.CMSTR0.BIT.STR0=1;	//?J?E?Åg?g?X?^?[?g
	CMT.CMSTR0.BIT.STR1=1;	//?J?E?Åg?g?X?^?[?g
	CMT.CMSTR1.BIT.STR2=1;	//?J?E?Åg?g?X?^?[?g
	
}


void timer_start(){
	init_clk();
}

void init_mpu(){
	init_sys();
	
	SCI_init();
	init_delay_clk();

}